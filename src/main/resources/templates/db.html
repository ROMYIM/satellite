<!DOCTYPE html >
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>添加数据库</title>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<base href="/satellite/"/>
        <link th:href="@{css/bootstrap.css}" rel="stylesheet" type="text/css" media="all"/>  
        <link th:href="@{css/style.css}" rel="stylesheet" type="text/css" media="all"/> 
		<link th:href="@{css/hover.css}" rel="stylesheet" type="text/css" media="all"/> 
		<script th:src="@{js/jquery-2.1.1.min.js}" type="text/javascript"></script>
    </head>
    <body>
        <div class="header-main">
			<div class="clearfix">
				<div class="logo-name">
					<h2  style="align-content: center">添加数据库</h2>
				</div>
			</div>
		</div>   
        <div class="chit-chat-layer1">
			<div class="col-md-4"></div>
            <div class="col-md-4 chit-chat-layer1-left">
                <div class="work-progres">
					<form class="form-horizontal" role="form" action="db/add">
						<div class="form-group">
							<label for="firstname" class="col-sm-2 control-label">地址</label>
							<div class="col-sm-10">
								<input type="text" class="form-control" id="url" name="url" placeholder="请输入url"/>
							</div>
						</div>
						<div class="form-group">
							<label for="lastname" class="col-sm-2 control-label">用户</label>
							<div class="col-sm-10">
								<input type="text" class="form-control" id="username" name="userName" placeholder="请输入用户名"/>
							</div>
						</div>
						<div class="form-group">
							<label for="lastname" class="col-sm-2 control-label">密码</label>
							<div class="col-sm-10">
								<input type="text" class="form-control" id="password" name="password" placeholder="请输入密码"/>
							</div>
						</div>
						<div class="form-group">
							<div class="col-sm-offset-2 col-sm-10">
								<button type="submit" class="btn btn-default">确认</button>
							</div>
						</div>
					</form>
                </div>
			</div>
			<div class="col-md-4"></div>
		</div>
	</body>
	<script th:inline="javascript" type="text/javascript">
		/*<![CDATA[*/
		var currentPage = 1;
		$(document).ready(function onload() {
			$('#pageNum').on('keypress', function (event) {
				if (event.keyCode == 13) {
					findLogsByTableName($('#pageNum').val() - 1);
				}
			})
			var html = '';
			var pageCount = '[[${pageCount}]]';
			for (let index = 0; index < pageCount; index++) {
				const pageNum = index;
				html += '<input id="' + pageNum + '" type="button" value="' + (pageNum + 1) + '" style="width: 2em; margin-left: 2px; margin-right: 2px" onclick="findLogsByTableName(' + pageNum + ')">';
			}
			if (html.length > 0) {
				$('#pageNum').html(html);
			}
		})

		function setCron() {
			var timingTime = $('#timingTime').val();
			var intervalTime = $('#intervalTime').val();
			$.ajax({
				url:'setCron',
				async:true,
				data:{timingTime:timingTime, intervalTime:intervalTime},
				dataType:'json',
				type:'post',
				success:function (data) {
					alert(data.message);
				},
				error:function(data) {
					alert(data);
				}
			})
		}

		function findLogsByTableName(page) {
				var objPageNum = document.getElementById('pageNum');
				var objSelectTable = document.getElementById('select_table');
				var objSelectDb = document.getElementById('target_db');
				var pageCount = document.getElementById('pageCount').innerHTML;
				var tableName;
				var targetDataBase;
				var pageNum;
				if (page == 'first') {
					pageNum = 0;
				} else if (page == 'last') {
					pageNum = currentPage - 2;
				} else if (page == 'next') {
					pageNum = currentPage;
				} else if (page == 'final') {
					pageNum = pageCount - 1;
				}
				if (isNaN(pageNum)) {
					pageNum = page;
				} else if (pageNum == undefined || pageNum == '') {
					pageNum = 0;
				}
				currentPage = parseInt(pageNum) + 1;
				if (objSelectTable.selectedIndex == 0) {
					tableName = null;
				} else {
					tableName = objSelectTable.options[objSelectTable.selectedIndex].value;
				}
				if (objSelectDb.selectedIndex == 0) {
					targetDataBase = null;
				} else {
					targetDataBase = objSelectDb.options[objSelectDb.selectedIndex].value;
				}
				$.ajax({
					url:'findLogs',
					async:true,
					type:'get',
					dataType:'json',
					data:{tableName:tableName, targetDb:targetDataBase, pageNum:pageNum * 20},
					success:function(data) {
						var html = '';
						var logList = data['result']['logList'];
						for (let i = 0; i < logList.length; i++) {
							html += '<tr>';
							const dataObj = logList[i];
							html += '<td>' + dataObj.id + '</td>';
							html += '<td>' + dataObj.tableName + '</td>';
							html += '<td>' + dataObj.insertCount + '</td>';
							html += '<td>' + dataObj.deleteCount + '</td>';
							html += '<td>' + dataObj.targetDataBase + '</td>';
							html += '<td>' + dataObj.operateTime + '</td>';
							html += '<td>' + dataObj.duration + '秒</td>';
							html += '</tr>';
						}
						if (html.length > 0 && pageNum >= 0) {
							$('#logList').html(html);
							pageCount = data['result']['pageCount'];
							html = pageCount + '';
							$('#pageCount').html(html);
							objPageNum.value = currentPage;
						} else {
							alert('没有数据了');
						}
					},
					error:function() {
						alert('获取失败');
					}
				});
			}
		/*]]>*/
	</script>
</html>